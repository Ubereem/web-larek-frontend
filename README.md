# WEB-ларёк

Интернет-магазин товаров для веб-разработчиков с возможностью просмотра каталога, добавления товаров в корзину и оформления заказа.

## Используемый стек

- TypeScript - типизированный JavaScript
- Webpack - сборщик модулей
- SCSS - препроцессор CSS
- HTML5 - разметка
- Event-driven architecture - событийно-ориентированная архитектура

## Инструкция по сборке и запуску

1. Установите зависимости:
```bash
npm install
```

2. Создайте файл `.env` в корне проекта:
```
API_ORIGIN=https://larek-api.nomoreparties.co
```

3. Запустите проект в режиме разработки:
```bash
npm start
```

4. Для сборки проекта:
```bash
npm run build
```

## Архитектура проекта

Проект построен на основе MVP (Model-View-Presenter) архитектуры с использованием событийно-ориентированного подхода для взаимодействия между компонентами.

### Основные принципы архитектуры

- Изолированность - каждый компонент может работать независимо
- Единственная ответственность - каждый класс решает одну конкретную задачу
- Масштабируемость - возможность расширения функциональности без изменения базового кода
- Событийно-ориентированное взаимодействие - компоненты общаются через события

### СЛОЙ МОДЕЛЬ

#### Класс ProductService
Назначение: Обеспечивает взаимодействие с сервером для получения данных о товарах.

Конструктор: 
- Принимает базовый URL для API

Поля класса:
- api: Api - клиент для работы с API

Методы:
- getProducts(): Promise<IProduct[]> - загружает товары с сервера
- createOrder(order: IOrder): Promise<{ total: number; items: string[] }> - создает заказ на сервере

#### Класс ProductModel
Назначение: Управляет данными о товарах.

Конструктор: 
- Не принимает параметров

Поля класса:
- items: IProduct[] - массив товаров

Методы:
- setItems(items: IProduct[]): void - устанавливает массив товаров (вызывается презентером)
- getProductById(id: string): IProduct | undefined - возвращает товар по ID из поля items
- getItems(): IProduct[] - возвращает весь массив товаров для отрисовки карточек в каталоге

#### Класс CartModel
Назначение: Управляет состоянием корзины пользователя.

Конструктор: 
- Не принимает параметров

Поля класса:
- items: ICartItem[] - массив товаров в корзине

Методы:
- addItem(product: IProduct): void - добавляет товар в корзину, создавая ICartItem с индексом
- removeItem(id: string): void - удаляет товар из корзины по ID
- clear(): void - очищает корзину
- getItems(): ICartItem[] - возвращает массив товаров в корзине
- getTotal(): number - вычисляет и возвращает общую стоимость корзины на основе цен товаров в items
- isInCart(id: string): boolean - проверяет, есть ли товар в корзине

#### Класс OrderModel
Назначение: Управляет данными формы заказа и валидацией.

Конструктор: 
- Не принимает параметров

Поля класса:
- form: Partial<IOrderForm> - данные формы заказа (способ оплаты, адрес, email, телефон)

Методы:
- setPayment(payment: 'card' | 'cash'): void - устанавливает способ оплаты
- setAddress(address: string): void - устанавливает адрес доставки
- setEmail(email: string): void - устанавливает email
- setPhone(phone: string): void - устанавливает телефон
- getForm(): Partial<IOrderForm> - возвращает данные формы заказа
- reset(): void - сбрасывает форму
- validate(): Partial<Record<keyof IOrderForm, string>> - проверяет валидность формы и возвращает объект с ошибками

### СЛОЙ ПРЕДСТАВЛЕНИЯ

#### Базовый класс ProductView
Назначение: Базовый класс для всех представлений товаров, содержащий только общий функционал.

Конструктор: 
- Принимает готовый DOM элемент товара (клон шаблона)

Поля класса:
- container: HTMLElement - DOM элемент товара
- _title: HTMLElement - заголовок товара
- _price: HTMLElement - цена товара

Сеттеры:
- set title(value: string) - устанавливает заголовок товара
- set price(value: number | null) - устанавливает цену товара

Методы:
- render(data?: Partial<IProduct>): HTMLElement - рендерит товар с переданными данными

#### Класс ModalView
Назначение: Управляет модальными окнами приложения.

Конструктор: 
- Принимает селектор контейнера модального окна

Поля класса:
- container: HTMLElement - контейнер модального окна
- content: HTMLElement - элемент для контента
- closeButton: HTMLElement - кнопка закрытия

Методы:
- open(): void - открывает модальное окно
- close(): void - закрывает модальное окно
- setContent(content: HTMLElement): void - устанавливает контент в модальное окно
- render() - рендерит модальное окно
- setDisabled(disabled: boolean): void - блокирует/разблокирует модальное окно

#### Класс ProductCardView
Назначение: Отображает карточку товара в каталоге.

Конструктор: 
- Наследует от ProductView

Поля класса:
- _image: HTMLImageElement - изображение товара
- _category: HTMLElement - категория товара
- _button: HTMLButtonElement - кнопка действия

Сеттеры:
- set image(value: string) - устанавливает изображение товара
- set category(value: ProductCategory) - устанавливает категорию товара
- set inCart(value: boolean) - изменяет состояние кнопки в зависимости от наличия в корзине

Методы:
- render(data?: Partial<IProduct>): HTMLElement - рендерит карточку с переданными данными

#### Класс ProductPreviewView
Назначение: Отображает детальную информацию о товаре в модальном окне.

Конструктор: 
- Наследует от ProductView

Поля класса:
- _image: HTMLImageElement - изображение товара
- _category: HTMLElement - категория товара
- _description: HTMLElement - описание товара
- _button: HTMLButtonElement - кнопка покупки

Сеттеры:
- set image(value: string) - устанавливает изображение товара
- set category(value: ProductCategory) - устанавливает категорию товара
- set description(value: string) - устанавливает описание товара
- set inCart(value: boolean) - изменяет текст кнопки в зависимости от состояния корзины

Методы:
- render(data?: Partial<IProduct>): HTMLElement - рендерит превью с переданными данными

#### Класс CartItemView
Назначение: Отображает товар в корзине.

Конструктор: 
- Наследует от ProductView

Поля класса:
- _index: HTMLElement - номер товара в корзине
- _deleteButton: HTMLButtonElement - кнопка удаления

Сеттеры:
- set index(value: number) - устанавливает номер товара
- set deleteHandler(handler: () => void) - устанавливает обработчик удаления

Методы:
- render(data?: Partial<ICartItem>): HTMLElement - рендерит товар в корзине с переданными данными

#### Класс CartView
Назначение: Отображает содержимое корзины.

Конструктор: 
- Принимает готовый DOM элемент корзины (клон шаблона)

Поля класса:
- container: HTMLElement - DOM элемент корзины
- _list: HTMLElement - список товаров
- _total: HTMLElement - общая стоимость
- _button: HTMLButtonElement - кнопка оформления заказа

Сеттеры:
- set items(value: ICartItem[]) - устанавливает список товаров
- set total(value: number) - устанавливает общую стоимость
- set disabled(value: boolean) - блокирует/разблокирует кнопку оформления

Методы:
- render(data?: Partial<{ items: ICartItem[], total: number }>): HTMLElement - рендерит корзину с переданными данными

#### Базовый класс FormView
Назначение: Базовый класс для всех форм, содержащий общий функционал.

Конструктор: 
- Принимает готовый DOM элемент формы (клон шаблона)

Поля класса:
- container: HTMLElement - DOM элемент формы
- _submitButton: HTMLButtonElement - кнопка отправки
- _errorsContainer: HTMLElement - контейнер для ошибок

Сеттеры:
- set errors(value: string[]) - отображает ошибки валидации
- set disabled(value: boolean) - блокирует/разблокирует форму

Методы:
- render(data?: Partial<{ errors: string[] }>): HTMLElement - рендерит форму с переданными данными
- clearErrors(): void - очищает ошибки

#### Класс PaymentFormView
Назначение: Отображает форму выбора способа оплаты и ввода адреса доставки.

Конструктор: 
- Наследует от FormView

Поля класса:
- _paymentButtons: HTMLButtonElement[] - кнопки выбора способа оплаты
- _addressInput: HTMLInputElement - поле ввода адреса

Сеттеры:
- set payment(value: 'card' | 'cash') - устанавливает выбранный способ оплаты
- set address(value: string) - устанавливает адрес

Методы:
- render(data?: Partial<{ payment: 'card' | 'cash', address: string }>): HTMLElement - рендерит форму с переданными данными

#### Класс ContactsFormView
Назначение: Отображает форму ввода контактных данных.

Конструктор: 
- Наследует от FormView

Поля класса:
- _emailInput: HTMLInputElement - поле ввода email
- _phoneInput: HTMLInputElement - поле ввода телефона

Сеттеры:
- set email(value: string) - устанавливает email
- set phone(value: string) - устанавливает телефон

Методы:
- render(data?: Partial<{ email: string, phone: string }>): HTMLElement - рендерит форму с переданными данными

#### Класс SuccessView
Назначение: Отображает сообщение об успешном оформлении заказа.

Конструктор: 
- Принимает готовый DOM элемент сообщения (клон шаблона)

Поля класса:
- container: HTMLElement - DOM элемент сообщения
- _title: HTMLElement - заголовок
- _description: HTMLElement - описание
- _button: HTMLButtonElement - кнопка закрытия

Сеттеры:
- set total(value: number) - устанавливает сумму заказа в описании
- set disabled(value: boolean) - блокирует/разблокирует кнопку

Методы:
- render(data?: Partial<{ total: number }>): HTMLElement - рендерит сообщение с переданными данными

### СЛОЙ ПРЕЗЕНТЕРА

Код презентера размещен в основном скрипте приложения (src/index.ts) и не выделен в отдельные классы. Презентер координирует взаимодействие между моделями, представлениями и API через систему событий.

**Роль презентера в работе с API:**
- Использует ProductService для получения данных о товарах с сервера
- Передает полученные данные в ProductModel через метод setItems()
- Получает данные из моделей (ProductModel, CartModel, OrderModel)
- Собирает необходимые объекты для отправки на сервер
- Использует ProductService для выполнения запросов к серверу
- Обрабатывает ответы сервера и обновляет модели и представления

### Базовые классы

#### Класс EventEmitter
Назначение: Обеспечивает работу событий в приложении.

Функции:
- Возможность установить и снять слушателей событий
- Вызов слушателей при возникновении события
- Поддержка регулярных выражений для фильтрации событий
- Возможность слушать все события

#### Класс Api
Назначение: Обеспечивает взаимодействие с сервером.

Функции:
- Выполнение GET и POST запросов
- Обработка ответов сервера
- Обработка ошибок
- Настройка заголовков запросов

### Событийно-ориентированное взаимодействие

Приложение использует событийно-ориентированный подход для взаимодействия между компонентами. Все события определены в перечислении AppEvents.

#### Пример взаимодействия при загрузке товаров:

1. При инициализации приложения презентер вызывает ProductService.getProducts()
2. ProductService выполняет запрос к серверу через Api
3. Полученные данные презентер передает в ProductModel через метод setItems()
4. ProductModel сохраняет данные и генерирует событие PRODUCTS_LOADED
5. Презентер обрабатывает событие PRODUCTS_LOADED и обновляет представления

#### Пример взаимодействия при добавлении товара в корзину:

1. ProductCardView реагирует на клик пользователя по кнопке "В корзину" и генерирует событие PRODUCT_SELECTED с данными товара
2. Презентер обрабатывает событие PRODUCT_SELECTED и вызывает метод addItem() модели CartModel
3. CartModel изменяет данные в поле items и генерирует событие CART_ITEM_ADDED
4. Презентер обрабатывает событие CART_ITEM_ADDED и вызывает метод render() у CartView и ProductCardView
5. Презентер обновляет счетчик товаров в шапке сайта, отображая актуальное количество товаров в корзине
6. CartView перерисовывается, отображая обновленный список товаров, а ProductCardView изменяет состояние кнопки на "Убрать из корзины"

#### Пример взаимодействия при удалении товара из корзины:

1. CartItemView реагирует на клик пользователя по кнопке удаления и генерирует событие PRODUCT_SELECTED с данными товара
2. Презентер обрабатывает событие PRODUCT_SELECTED и вызывает метод removeItem() модели CartModel
3. CartModel изменяет данные в поле items и генерирует событие CART_ITEM_REMOVED
4. Презентер обрабатывает событие CART_ITEM_REMOVED и вызывает метод render() у CartView и ProductCardView
5. Презентер обновляет счетчик товаров в шапке сайта, отображая актуальное количество товаров в корзине
6. CartView перерисовывается, отображая обновленный список товаров, а ProductCardView изменяет состояние кнопки на "В корзину"

#### Пример взаимодействия при отправке заказа:

1. PaymentFormView реагирует на отправку формы и генерирует событие ORDER_SUBMITTED (все данные уже в модели)
2. Презентер обрабатывает событие ORDER_SUBMITTED и открывает форму с почтой и телефоном (ContactsFormView)
3. ContactsFormView реагирует на отправку формы и генерирует событие ORDER_SUBMITTED (все данные уже в модели)
4. Презентер обрабатывая второе событие ORDER_SUBMITTED выполняет следующие действия:
   - Взять данные покупателя из модели OrderModel
   - Взять сумму покупки из CartModel
   - Взять список id товаров из CartModel
   - Собрать из всего этого один объект, в том виде, как его требует сервер
   - Отправить подготовленный объект на сервер через ProductService
   - В блоке then получить ответ сервера и взять из него сумму покупки подтвержденную сервером
   - Очистить корзину, данные покупателя
   - Отобразить окно подтверждения, передав в него сумму покупки полученную с сервера

### Компоненты и их связи

- Презентер ↔ ProductService - получает данные о товарах с сервера и отправляет заказы
- Презентер ↔ ProductModel - передает данные о товарах и получает их для отображения
- Презентер ↔ CartModel - получает данные корзины
- Презентер ↔ OrderModel - получает данные формы заказа
- ProductService ↔ Api - выполняет запросы к серверу для получения товаров и создания заказов
- CartModel ↔ ProductModel - корзина работает с товарами из модели
- ModalView ↔ ProductPreviewView/CartView/PaymentFormView/ContactsFormView/SuccessView - модальное окно отображает различные представления
- ProductCardView ↔ ProductPreviewView - карточка товара может открыть превью
- CartView ↔ PaymentFormView - корзина может открыть форму оплаты
- PaymentFormView ↔ ContactsFormView - форма оплаты может перейти к форме контактов
- ContactsFormView ↔ SuccessView - форма контактов может показать успех

### Данные в приложении

- IProduct - данные товара (id, title, description, image, category, price)
- ICartItem - товар в корзине (id, title, price, index)
- IOrderForm - данные формы заказа (payment, address, email, phone)
- IOrder - данные для отправки заказа (total, items)

**Примечание:** Данные корзины (items, total) не хранятся в отдельном интерфейсе ICart, а получаются через методы CartModel.getItems() и CartModel.getTotal() перед отправкой заказа на сервер. Презентер собирает объект IOrder из данных CartModel и OrderModel, затем использует ProductService для отправки заказа.

### Процессы в приложении

Все процессы реализованы через события:
- Загрузка товаров: PRODUCTS_LOADED
- Выбор товара: PRODUCT_SELECTED
- Добавление в корзину: CART_ITEM_ADDED
- Удаление из корзины: CART_ITEM_REMOVED
- Открытие корзины: CART_OPENED
- Изменение формы заказа: ORDER_PAYMENT_CHANGED, ORDER_ADDRESS_CHANGED, etc.
- Отправка заказа: ORDER_SUBMITTED
- Успешное оформление: ORDER_SUCCESS
- Открытие/закрытие модальных окон: MODAL_OPENED, MODAL_CLOSED
- Валидация форм: FORM_VALIDATED, FORM_ERRORS

### Валидация форм

Метод `validate()` в OrderModel возвращает объект с ошибками валидации:
- Если поле валидно - оно отсутствует в объекте
- Если поле невалидно - содержит текст ошибки

Пример возвращаемого объекта:
```typescript
{
  email: 'Не указан email',
  phone: 'Не указан телефон'
}
```

Презентер анализирует объект ошибок:
- Отсутствие полей означает их валидность
- Наличие полей с текстом означает ошибки валидации
- Готовые тексты ошибок передаются в представления для отображения
